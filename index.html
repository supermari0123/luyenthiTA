<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luyện đề đầu vào Tiếng Anh Đại Học</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        /* CSS không thay đổi, giữ nguyên như phiên bản trước */
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;700&display=swap');
        :root {
            --primary-color: #ff7e9a; --secondary-color: #8A2BE2; --light-color: #fff; --text-color: #4a4a4a;
            --bg-color: #f3e5f5; --card-bg-color: #fdfcff; --border-radius: 16px;
            --shadow: 0 8px 25px rgba(142, 68, 173, 0.08); --danger-color: #e74c3c;
            --danger-hover-color: #c0392b; --success-color: #2ecc71; --success-hover-color: #27ae60;
            --info-color: #3498db; --info-hover-color: #2980b9;
            --warning-color: #f39c12; --warning-hover-color: #e67e22;
        }
        body { font-family: 'Quicksand', sans-serif; line-height: 1.7; margin: 0; background: linear-gradient(135deg, #f3e5f5, #e1bee7); color: var(--text-color); }
        #app-root { display: flex; flex-direction: column; min-height: 100vh; }
        #app-body { display: flex; flex-grow: 1; }
        #sidebar-nav { width: 260px; background: var(--card-bg-color); padding: 20px; display: flex; flex-direction: column; box-shadow: 5px 0 15px rgba(0,0,0,0.05); z-index: 10; }
        #main-content-area { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .card { background: var(--card-bg-color); padding: 30px; border-radius: var(--border-radius); box-shadow: var(--shadow); }
        h2 { margin-top: 0; color: var(--primary-color); display: flex; align-items: center; }
        h2 .icon { width: 1.2em; height: 1.2em; margin-right: 10px; vertical-align: -0.2em; }
        h3 { color: var(--secondary-color); }
        .action-button { background-color: var(--primary-color); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: background-color 0.3s; font-size: 1.1em; width: 100%; }
        .action-button:hover { background-color: #e66a87; }
        .input-group { margin-bottom: 15px; }
        .input-group label { font-weight: 700; display: block; margin-bottom: 5px; }
        .input-group input, .input-group select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        .checkbox-group { display: flex; align-items: center; margin-top: 10px; }
        .checkbox-group input { width: auto; margin-right: 10px; }
        textarea { min-height: 200px; }
        .admin-table { width: 100%; border-collapse: separate; border-spacing: 0 5px; margin-top: 20px; }
        .admin-table th, .admin-table td { padding: 15px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; }
        .admin-table th { background-color: transparent; font-size: 0.9em; color: #aaa; text-transform: uppercase; border: none; }
        .admin-table tr:hover td { background-color: #f9f6fc; }
        .admin-table td:first-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
        .admin-table td:last-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
        .admin-action-btn { font-size: 0.8em; padding: 8px 12px; margin: 2px; width: auto; border: none; color: white; border-radius: 6px; font-weight: 700; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .admin-action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .admin-action-btn:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-ban { background-color: var(--danger-color); } .btn-ban:hover { background-color: var(--danger-hover-color); }
        .btn-unban { background-color: var(--success-color); } .btn-unban:hover { background-color: var(--success-hover-color); }
        .btn-edit-user { background-color: var(--info-color); } .btn-edit-user:hover { background-color: var(--info-hover-color); }
        .btn-clear-scores { background-color: var(--warning-color); } .btn-clear-scores:hover { background-color: var(--warning-hover-color); }
        .sidebar-header { text-align: center; margin-bottom: 30px; }
        .sidebar-header .icon { font-size: 4em; color: var(--primary-color); }
        .sidebar-nav-btn { display: flex; align-items: center; width: 100%; padding: 15px; background: none; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 700; cursor: pointer; text-align: left; margin-bottom: 10px; transition: all 0.3s ease; }
        .sidebar-nav-btn:hover { background: var(--bg-color); color: var(--primary-color); }
        .sidebar-nav-btn.active { background: var(--primary-color); color: var(--light-color); }
        .sidebar-footer { margin-top: auto; text-align: center; }
        #user-dashboard-layout { display: flex; gap: 30px; }
        #user-dashboard-main { flex: 2; display: flex; flex-direction: column; gap: 30px; }
        #user-dashboard-sidebar { flex: 1; display: flex; flex-direction: column; gap: 30px; }
        .user-stats-card { text-align: center; }
        .user-stats-card h3 { font-size: 1.8em; color: var(--secondary-color); margin-bottom: 20px; }
        .user-stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-item { background: #f5f5f5; padding: 15px; border-radius: 10px; }
        .stat-item .value { font-size: 1.5em; font-weight: 700; color: var(--primary-color); }
        .stat-item .label { font-size: 0.9em; color: #777; }
        #category-showcase-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; }
        .category-showcase-card { background: linear-gradient(135deg, var(--secondary-color), #c37ff0); color: white; padding: 25px; border-radius: var(--border-radius); text-align: center; cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; box-shadow: 0 4px 15px rgba(138, 43, 226, 0.2); }
        .category-showcase-card:hover { transform: translateY(-8px); box-shadow: 0 12px 25px rgba(138, 43, 226, 0.3); }
        .category-showcase-card .icon { font-size: 3em; margin-bottom: 10px; }
        .category-showcase-card h3 { color: white; font-size: 1.5em; margin: 0; }
        #test-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .test-card { display: flex; flex-direction: column; justify-content: space-between; border: 1px solid #e0e0e0; border-radius: 12px; padding: 15px; transition: box-shadow 0.3s ease, transform 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .test-card:hover { transform: translateY(-5px); box-shadow: var(--shadow); }
        .test-card h3 { font-size: 1.1em; margin: 0 0 10px 0; color: var(--secondary-color); }
        .test-card p { font-size: 0.9em; margin: 0 0 15px 0; color: #777; }
        .test-card-footer { margin-top: auto; }
        .btn-start { background-color: var(--primary-color); color: white; width: 100%; padding: 8px 15px; font-size: 0.9em; font-weight: 700; border-radius: 8px; border: none; cursor: pointer; box-shadow: 0 2px 5px rgba(255, 126, 154, 0.4); transition: all 0.2s ease; }
        .btn-start:hover { background-color: #e66a87; transform: translateY(-2px); box-shadow: 0 4px 10px rgba(255, 126, 154, 0.5); }
        .btn-start:active { transform: translateY(0); box-shadow: 0 2px 5px rgba(255, 126, 154, 0.4); }
        .status-locked { text-align: center; font-size: 0.9em; padding: 10px; background-color: #f1f1f1; border-radius: 8px; color: #999; }
        .action-btn-small { width:auto; font-size:0.8em !important; padding: 6px 10px !important; margin: 2px; }
        .btn-delete { background-color: var(--danger-color) !important; }
        .btn-delete:hover { background-color: var(--danger-hover-color) !important; }
        #admin-test-list .test-card-footer { display:flex; flex-wrap: wrap; gap: 5px; }
        .icon-fire { color: #ff6d00; width: 1.1em; height: 1.1em; vertical-align: -0.15em; margin-left: 5px; }
        .leaderboard-tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .leaderboard-tabs button { background: none; border: none; padding: 10px 15px; font-size: 1em; font-weight: 700; cursor: pointer; color: #999; border-bottom: 3px solid transparent; transition: all 0.3s ease; }
        .leaderboard-tabs button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        #leaderboard-timer { display: block; text-align: center; color: #aaa; font-size: 0.8em; margin-bottom: 15px; }
        .tip-card { background: linear-gradient(135deg, #8A2BE2, #9b59b6); color: white; }
        .tip-card h3 { color: white; font-size: 1.2em; margin: 0 0 10px 0; }
        .tip-card p { font-size: 1em; font-style: italic; }
        .passage-block { background: #f7f7f7; border-left: 4px solid var(--primary-color); padding: 15px; margin-bottom: 20px; border-radius: 8px; white-space: pre-wrap; }
        .history-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #f0f0f0; }
        .btn-review { font-size: 0.8em; padding: 4px 8px; margin-left: 10px; background-color: var(--info-color); color: white; border-radius: 5px; border: none; cursor: pointer; }
        @media (max-width: 992px) { #user-dashboard-layout { flex-direction: column; } }
        @media (max-width: 768px) { #app-body { flex-direction: column; } #sidebar-nav { width: 100%; height: auto; flex-direction: row; justify-content: space-around; padding: 10px; } #main-content-area { padding: 15px; } }
    </style>
</head>
<body>
    <!-- SVG Icons -->
    <svg style="display:none">
        <symbol id="icon-thpt" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3L1 9l11 6 9-4.91V17h2V9L12 3zm0 8.48L5.52 8 12 4.52 18.48 8 12 11.48zM17 18v-2h-2v2h-2v2h2v2h2v-2h2v-2h-2z"/></symbol>
        <symbol id="icon-toeic" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93s3.05-7.44 7-7.93v15.86zm2-15.86c1.03.13 2 .45 2.87.93L15.87 9H14V4.07zM14 11h1.87l.94 2H14v-2zm0 4h2.74l.93 2h-3.67v-2zm2.87 4.93c.88-.49 1.67-1.16 2.26-1.93H16.87v-1h.93l-.93-2h-.93v-1h.93l-.93-2h-.93V9h2.13c.04-.33.07-.66.07-1c0-2.06-1.1-3.86-2.73-4.8A8.01 8.01 0 0 1 14 4.07V18.93z"/></symbol>
        <symbol id="icon-practice" viewBox="0 0 24 24"><path fill="currentColor" d="M14.06 9.94L15.5 8.5L12 5l-3.5 3.5l1.44 1.44L12 7.88l2.06 2.06zM12 16.12L9.94 14.06L8.5 15.5L12 19l3.5-3.5l-1.44-1.44L12 16.12zM3.5 12L5 10.56l2.06 2.06L5.62 14L3.5 12zm15.06-1.44L16.5 12l2.12-2.12l1.44 1.44zM19 12l-1.44-1.44l-2.06 2.06L16.94 14L19 12zM5.44 9.94L3.5 12l2.12 2.12l1.44-1.44L5.44 11.06z"/></symbol>
        <symbol id="icon-beginner" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4s-4 1.79-4 4s1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24"><path fill="currentColor" d="M19,13H13v6H11V13H5v-2h6V5h2v6h6v2Z"/></symbol>
        <symbol id="icon-list" viewBox="0 0 24 24"><path fill="currentColor" d="M3,5h18v2H3V5Zm0,6h18v2H3v-2Zm0,6h18v2H3v-2Z"/></symbol>
        <symbol id="icon-cup" viewBox="0 0 24 24"><path fill="currentColor" d="M18.32,8H5.67A2.68,2.68,0,0,0,3,10.68V15.5A4.5,4.5,0,0,0,7.5,20h9A4.5,4.5,0,0,0,21,15.5V10.68A2.68,2.68,0,0,0,18.32,8Zm-1.82,7H7.5a2.5,2.5,0,0,1,0-5h9a2.5,2.5,0,0,1,0,5Z M1,9H3V7A2,2,0,0,0,1,5V4A2,2,0,0,1,3,2H1A2,2,0,0,0,1,4Z"/></symbol>
        <symbol id="icon-history" viewBox="0 0 24 24"><path fill="currentColor" d="M13,3a9,9,0,0,0-9,9H1l3.89,3.89.07.14L9,12H6a7,7,0,0,1,7-7,7,7,0,0,1,7,7,7,7,0,0,1-7,7v2a9,9,0,0,0,9-9A9,9,0,0,0,13,3Z"/></symbol>
        <symbol id="icon-logout" viewBox="0 0 24 24"><path fill="currentColor" d="M16,17v-3H9v-4h7V7l5,5-5,5M14,2a2,2,0,0,1,2,2v2H14V4H5v16h9v-2h2v2a2,2,0,0,1-2,2H5a2,2,0,0,1-2-2V4A2,2,0,0,1,5,2h9Z"/></symbol>
        <symbol id="icon-users" viewBox="0 0 24 24"><path fill="currentColor" d="M16 17v2h-2v-2h2zm-4 0v2h-2v-2h2zm-4 0v2H6v-2h2zM16.5 8c1.38 0 2.5-1.12 2.5-2.5S17.88 3 16.5 3S14 4.12 14 5.5s1.12 2.5 2.5 2.5zM9 11c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm7.5 3c-1.83 0-5.5.92-5.5 2.75V19h11v-2.25c0-1.83-3.67-2.75-5.5-2.75zM9 13c-2.33 0-7 1.17-7 3.5V19h7v-2.25c0-.85.33-2.34 2.37-3.47C10.5 13.1 9.66 13 9 13z"/></symbol>
        <symbol id="icon-chart" viewBox="0 0 24 24"><path fill="currentColor" d="M4 4h16v2H4V4zm0 4h16v12H4V8zm2 2v8h12v-8H6zM8 12h2v4H8v-4zm4 0h2v4h-2v-4z"/></symbol>
        <symbol id="icon-fire" viewBox="0 0 24 24"><path fill="currentColor" d="M17.5,2.5c-2.2,0-3.9,1.8-3.9,4c0,1.5,0.8,2.8,2,3.5c-0.6,0.3-1.1,0.8-1.5,1.4C13,12,12.5,13.2,12.5,14.5c0,1.3,0.5,2.5,1.4,3.4c0.9,0.9,2.1,1.4,3.4,1.4c1.3,0,2.5-0.5,3.4-1.4c0.9-0.9,1.4-2.1,1.4-3.4c0-1.3-0.5-2.5-1.4-3.4c-0.4-0.6-0.9-1.1-1.5-1.4c1.2-0.7,2-2,2-3.5C21.4,4.3,19.7,2.5,17.5,2.5z M10.4,8.5C10.8,8.2,11,7.8,11,7.2c0-1-0.8-1.8-1.8-1.8S7.5,6.2,7.5,7.2c0,0.5,0.2,1,0.5,1.3C6.7,9.2,6,10.6,6,12.2c0,1.7,0.7,3.2,1.8,4.3c1.1,1.1,2.6,1.8,4.3,1.8c0.8,0,1.6-0.2,2.3-0.5c-1.2-0.9-2-2.3-2-3.8c0-1.6,0.8-3,2-3.8C13.5,9.6,12.2,9,10.4,8.5z"/></symbol>
        <symbol id="icon-dashboard" viewBox="0 0 24 24"><path fill="currentColor" d="M13 3v6h8V3h-8zM3 13v8h8v-8H3zm6 6H5v-4h4v4zm-6-8h8V3H3v8zm2-6h4v4H5V5zM13 21v-6h8v6h-8zm2-4h4v2h-4v-2z"/></symbol>
        <symbol id="icon-lightbulb" viewBox="0 0 24 24"><path fill="currentColor" d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74c0-3.86-3.14-7-7-7z"/></symbol>
    </svg>
    <div id="app-root"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBdBitxn6awNnMNo635WtDNSKuNodp9ACI",
            authDomain: "my-sql-to-english.firebaseapp.com",
            databaseURL: "https://my-sql-to-english-default-rtdb.firebaseio.com",
            projectId: "my-sql-to-english",
            storageBucket: "my-sql-to-english.firebasestorage.app",
            messagingSenderId: "56688139064",
            appId: "1:56688139064:web:48ec3e898815f3c56e7fcd",
            measurementId: "G-34BJ7YEY5R"
        };
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();
        
        const CATEGORIES = [ { name: 'Đề THPT', icon: 'thpt' }, { name: 'Đề TOEIC', icon: 'toeic' }, { name: 'Đề Luyện Thi', icon: 'practice' }, { name: 'Mất Gốc', icon: 'beginner' } ];
        const templates = {
            landing: `<div id="landing-view" style="text-align: center; padding: 50px 20px; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;"><h1>Chào mừng đến với<br>Nền tảng Luyện Thi Tiếng Anh</h1><p style="font-size: 1.2em; max-width: 600px;">Chinh phục các bài thi đầu vào đại học một cách tự tin và hiệu quả.</p><div id="login-card-wrapper" class="login-card card" style="max-width: 400px; width: 100%; margin-top: 40px;"></div></div>`,
            loginForm: `<form id="login-form"><h2>Đăng Nhập</h2><div class="input-group"><label for="login-username">Tên đăng nhập</label><input type="text" id="login-username" required></div><div class="input-group"><label for="login-password">Mật khẩu</label><input type="password" id="login-password" required></div><button class="action-button" type="submit">Đăng Nhập</button><p style="text-align:center; margin-top:15px; cursor:pointer;" onclick="app.render('registerForm', '#login-card-wrapper')">Chưa có tài khoản? <span style="color:var(--primary-color); font-weight:700;">Đăng ký ngay</span></p></form>`,
            registerForm: `<form id="register-form"><h2>Đăng Ký</h2><div class="input-group"><label for="register-username">Tên đăng nhập</label><input type="text" id="register-username" required></div><div class="input-group"><label for="register-password">Mật khẩu</label><input type="password" id="register-password" required></div><button class="action-button" type="submit">Đăng Ký</button><p style="text-align:center; margin-top:15px; cursor:pointer;" onclick="app.render('loginForm', '#login-card-wrapper')">Đã có tài khoản? <span style="color:var(--primary-color); font-weight:700;">Đăng nhập</span></p></form>`,
            appLayout: `<div id="app-body"><nav id="sidebar-nav"><div class="sidebar-header"><div class="icon">🎓</div><h3 id="welcome-user"></h3></div><div id="sidebar-menu"></div><div class="sidebar-footer"><button class="action-button logout-btn" style="background: #e74c3c; font-size:1em;"><svg class="icon" style="width:1em;height:1em;vertical-align:-0.125em;"><use href="#icon-logout"></use></svg> Đăng Xuất</button></div></nav><main id="main-content-area"></main></div>`,
            adminCreateTest: `<div class="card"> <h2 id="create-edit-title">Tạo Đề Thi Mới</h2> <p style="font-size:0.9em; color:#888;"><b>Mẹo:</b> Để tạo đoạn văn đọc hiểu (TOEIC), hãy bắt đầu một dòng bằng <b>[PASSAGE]</b>. Các câu hỏi theo sau vẫn giữ nguyên định dạng.</p> <input type="hidden" id="test-id-edit"> <div class="input-group"><label>Tên Đề Thi:</label><input type="text" id="test-title"></div> <div class="input-group"><label>Thời gian (phút):</label><input type="number" id="test-time"></div> <div class="input-group"><label>Số lần làm tối đa:</label><input type="number" id="test-attempts" placeholder="Để trống cho vô hạn"></div> <div class="input-group"><label>Phân loại:</label><select id="test-category"></select></div> <div class="checkbox-group"><input type="checkbox" id="allow-view-answer" checked><label for="allow-view-answer">Cho phép xem đáp án và giải thích</label></div> <div class="input-group"><label>URL file nghe:</label><input type="text" id="test-audio-url" placeholder="Để trống nếu không phải đề nghe"></div> <div class="input-group"><label>Nội dung câu hỏi:</label><textarea id="quiz-input" placeholder="Soạn đề thi tại đây..."></textarea></div> <button class="action-button" id="save-test-btn">LƯU ĐỀ THI</button> </div>`,
            adminManage: `<div class="card"><h2><svg class="icon"><use href="#icon-list"></use></svg> Quản Lý Đề Thi</h2><div id="admin-test-list"></div></div>`,
            adminManageUsers: `<div class="card"><h2><svg class="icon"><use href="#icon-users"></use></svg> Quản Lý Tài Khoản</h2><div id="user-management-table"></div></div>`,
            userDashboard: `<div id="user-dashboard-layout"><div id="user-dashboard-main"><div id="user-stats-card-container"></div><div class="card"><h2><svg class="icon"><use href="#icon-list"></use></svg> Chọn Chuyên Mục</h2><div id="category-showcase-grid"></div></div></div><div id="user-dashboard-sidebar"><div class="card"><h2><svg class="icon"><use href="#icon-cup"></use></svg> Bảng Xếp Hạng</h2><small id="leaderboard-timer"></small><div id="leaderboard-container"></div></div><div class="card"><h2><svg class="icon"><use href="#icon-chart"></use></svg> Tiến độ của bạn</h2><canvas id="progress-chart"></canvas></div><div id="user-history-card" class="card"><h2><svg class="icon"><use href="#icon-history"></use></svg> Lịch sử làm bài</h2><div id="user-history"></div></div></div></div>`,
            categoryView: `<div class="card"><button onclick="app.renderView('userDashboard')" style="background: #ccc; color:#333; width:auto; padding: 8px 15px; font-size: 0.9em; margin-bottom: 20px;" class="action-button">← Quay lại</button><h2 id="category-view-title"></h2><div id="test-grid"></div></div>`,
            resultsView: `<div class="card"><h2 id="results-title">Kết quả bài thi</h2><h3 id="score-summary" style="font-size: 1.8em; text-align: center; color: var(--secondary-color);"></h3><div id="results-breakdown"></div><button id="back-btn" class="action-button" style="margin-top: 20px;">Về trang chính</button></div>`
        };

        const app = {
            currentUser: null, currentQuiz: null, timerInterval: null, progressChart: null, leaderboardTimerInterval: null,
            users: [], tests: [], scores: [],
            studyTips: ["Đừng học nhồi nhét. Chia nhỏ thời gian học thành các phiên ngắn sẽ hiệu quả hơn.", "Dạy lại cho người khác là cách tốt nhất để kiểm tra kiến thức của chính mình.", "Ngủ đủ giấc. Một bộ não được nghỉ ngơi sẽ tiếp thu thông tin tốt hơn rất nhiều.", "Luyện tập với các đề thi cũ để làm quen với cấu trúc và áp lực thời gian.", "Hãy đặt mục tiêu thực tế và ăn mừng những thành tích nhỏ trên con đường chinh phục mục tiêu lớn.", "Học từ vựng theo chủ đề sẽ giúp bạn nhớ lâu và có hệ thống hơn.", "Đừng ngại mắc lỗi. Lỗi sai là cơ hội để bạn học hỏi và trở nên tốt hơn."],
        
            async init() {
                document.getElementById('app-root').innerHTML = '<h2 style="text-align:center; padding-top: 50px;">Đang tải dữ liệu, vui lòng chờ...</h2>';
                await this.loadData();
                const loggedInUser = sessionStorage.getItem('quiz_currentUser_v4');
                if (loggedInUser) { this.currentUser = JSON.parse(loggedInUser); this.render('appLayout'); } 
                else { this.render('landing'); }
            },
            async loadData() {
                try {
                    const snapshot = await db.ref().once('value');
                    const data = snapshot.val() || {};
                    this.users = data.users ? Object.values(data.users) : [];
                    this.tests = data.tests ? Object.values(data.tests) : [];
                    this.scores = data.scores ? Object.values(data.scores) : [];
                    const adminExists = this.users.some(u => u.username === 'admin');
                    if (!adminExists) { const adminUser = { username: 'admin', password: 'admin', isAdmin: true, isBanned: false }; await db.ref('users/admin').set(adminUser); this.users.push(adminUser); }
                } catch (error) { console.error("Lỗi khi tải dữ liệu từ Firebase:", error); alert("Không thể kết nối đến cơ sở dữ liệu. Vui lòng kiểm tra lại cấu hình Firebase của bạn."); }
            },
            
            render(templateName, targetSelector = '#app-root') { const target = document.querySelector(targetSelector); if(target) target.innerHTML = templates[templateName] || ''; this.addEventListeners(templateName); },
            renderContent(templateName) { this.render(templateName, '#main-content-area'); },
            addEventListeners(viewName) {
                if (viewName === 'landing') this.render('loginForm', '#login-card-wrapper');
                if (viewName === 'loginForm') document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); this.login(); });
                if (viewName === 'registerForm') document.getElementById('register-form').addEventListener('submit', (e) => { e.preventDefault(); this.register(); });
                if (viewName === 'appLayout') {
                    document.querySelectorAll('.logout-btn').forEach(btn => btn.addEventListener('click', this.logout.bind(this)));
                    document.getElementById('welcome-user').innerText = `Chào, ${this.currentUser.username}`;
                    this.renderSidebar();
                    this.renderView(this.currentUser.isAdmin ? 'adminManage' : 'userDashboard');
                }
                if(viewName === 'adminCreateTest') {
                    document.getElementById('save-test-btn').addEventListener('click', this.saveTest.bind(this));
                    document.getElementById('test-category').innerHTML = CATEGORIES.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
                }
            },
            async renderView(viewName, data = { forceReload: false }) {
                if (data.forceReload) { await this.loadData(); }
                document.querySelectorAll('.sidebar-nav-btn').forEach(b => b.classList.remove('active'));
                const activeBtn = Array.from(document.querySelectorAll('.sidebar-nav-btn')).find(btn => btn.innerHTML.includes(`icon-${data.icon || viewName.replace('admin','')}`));
                if (activeBtn) activeBtn.classList.add('active');
                
                this.renderContent(viewName);
                
                if (viewName === 'adminManage') this.renderAdminTestList();
                if (viewName === 'adminManageUsers') this.renderManageUsers();
                if (viewName === 'userDashboard') { this.renderUserStats(); this.renderCategoryShowcase(); this.renderLeaderboards(); this.renderProgressChart(); this.renderUserHistory(); this.renderTipOfTheDay(); }
                if (viewName === 'categoryView') this.renderTestGridForCategory(data.categoryName);
                if (viewName === 'resultsView') this.renderResults(data.scoreRecordKey);
            },
            renderSidebar() { const menu = document.getElementById('sidebar-menu'); menu.innerHTML = ''; let navItems = this.currentUser.isAdmin ? [ { view: 'userDashboard', icon: 'dashboard', text: 'Trang Chính' }, { view: 'adminCreateTest', icon: 'plus', text: 'Tạo Đề Mới' }, { view: 'adminManage', icon: 'list', text: 'Quản Lý Đề' }, { view: 'adminManageUsers', icon: 'users', text: 'Quản Lý Tài Khoản' } ] : [ { view: 'userDashboard', icon: 'dashboard', text: 'Trang Chính' } ]; navItems.forEach(item => { const btn = document.createElement('button'); btn.className = 'sidebar-nav-btn'; btn.innerHTML = `<svg class="icon" style="width:1.5em; height:1.5em; margin-right: 15px;"><use href="#icon-${item.icon}"></use></svg><span>${item.text}</span>`; btn.onclick = () => this.renderView(item.view, { icon: item.icon }); menu.appendChild(btn); }); },
            async login() { const username = document.getElementById('login-username').value; const password = document.getElementById('login-password').value; await this.loadData(); const foundUser = this.users.find(usr => usr.username === username && usr.password === password); if (foundUser) { if (foundUser.isBanned) { alert('Tài khoản của bạn đã bị khóa.'); return; } this.currentUser = foundUser; sessionStorage.setItem('quiz_currentUser_v4', JSON.stringify(this.currentUser)); this.render('appLayout'); } else { alert('Tài khoản hoặc mật khẩu không đúng!'); } },
            async register() { const username = document.getElementById('register-username').value; const password = document.getElementById('register-password').value; if (!username.trim() || !password.trim()) { alert("Vui lòng điền đủ thông tin!"); return; } await this.loadData(); if (this.users.find(usr => usr.username === username)) { alert('Tên đăng nhập đã tồn tại!'); return; } const newUser = { username, password, isAdmin: false, isBanned: false }; try { await db.ref('users/' + username).set(newUser); alert('Đăng ký thành công!'); this.render('loginForm', '#login-card-wrapper'); } catch (error) { console.error("Lỗi khi đăng ký:", error); alert("Đã xảy ra lỗi khi đăng ký. Vui lòng thử lại."); } },
            logout() { this.currentUser = null; clearInterval(this.leaderboardTimerInterval); sessionStorage.removeItem('quiz_currentUser_v4'); this.render('landing'); },
            async promptEditPassword(username) { const newPassword = prompt(`Nhập mật khẩu mới cho tài khoản "${username}":`); if (newPassword && newPassword.trim() !== '') { try { await db.ref('users/' + username + '/password').set(newPassword.trim()); alert(`Đã cập nhật mật khẩu cho ${username}.`); this.renderView('adminManageUsers', { forceReload: true, icon: 'users' }); } catch(error) { alert("Có lỗi xảy ra, không thể cập nhật."); } } else if (newPassword !== null) { alert("Mật khẩu không được để trống."); } },
            async toggleBanUser(username) { const user = this.users.find(u => u.username === username); if (user) { try { const newBanStatus = !user.isBanned; await db.ref('users/' + username + '/isBanned').set(newBanStatus); alert(`Đã ${newBanStatus ? 'cấm' : 'bỏ cấm'} tài khoản ${username}.`); this.renderView('adminManageUsers', { forceReload: true, icon: 'users' }); } catch(error) { alert("Có lỗi xảy ra, không thể cập nhật."); } } },
            async clearUserScores(username) { if (confirm(`Bạn có chắc chắn muốn xóa TOÀN BỘ điểm của người dùng "${username}"? Hành động này không thể hoàn tác.`)) { try { const scoresSnapshot = await db.ref('scores').orderByChild('username').equalTo(username).once('value'); const scoresToDelete = scoresSnapshot.val(); if (scoresToDelete) { const updates = {}; Object.keys(scoresToDelete).forEach(key => { updates[key] = null; }); await db.ref('scores').update(updates); } alert(`Đã xóa toàn bộ điểm của ${username}.`); this.renderView('adminManageUsers', { forceReload: true, icon: 'users' }); } catch (error) { console.error("Lỗi khi xóa điểm:", error); alert("Đã xảy ra lỗi."); } } },
            async resetUserAttempts(testId, testTitle) {
                const username = prompt(`Nhập tên người dùng cần reset lượt thi cho đề "${testTitle}":`);
                if (!username || !username.trim()) return;
                const userExists = this.users.find(u => u.username === username.trim());
                if (!userExists) { alert(`Không tìm thấy người dùng "${username}".`); return; }
                if (confirm(`Bạn có chắc chắn muốn reset toàn bộ lượt thi của "${username}" cho đề "${testTitle}"?`)) {
                    try {
                        const scoresSnapshot = await db.ref('scores').orderByChild('username').equalTo(username.trim()).once('value');
                        const scoresData = scoresSnapshot.val();
                        if (scoresData) {
                            const updates = {}; let foundScores = false;
                            for (const key in scoresData) { if (scoresData[key].testId === testId) { updates[key] = null; foundScores = true; } }
                            if (foundScores) { await db.ref('scores').update(updates); alert(`Đã reset lượt thi cho "${username}" thành công.`); this.renderView('adminManage', { forceReload: true, icon: 'list' }); } 
                            else { alert(`Không tìm thấy lượt thi nào của "${username}" cho đề này.`); }
                        } else { alert(`Người dùng "${username}" chưa có điểm nào.`); }
                    } catch (error) { console.error("Lỗi khi reset lượt thi:", error); alert("Đã xảy ra lỗi."); }
                }
            },
            async saveTest() { const testId = document.getElementById('test-id-edit').value || Date.now(); const testData = { id: testId, title: document.getElementById('test-title').value.trim(), timeLimit: parseInt(document.getElementById('test-time').value, 10), maxAttempts: document.getElementById('test-attempts').value ? parseInt(document.getElementById('test-attempts').value, 10) : Infinity, category: document.getElementById('test-category').value, showAnswers: document.getElementById('allow-view-answer').checked, audioUrl: document.getElementById('test-audio-url').value.trim(), questions: this.parseQuizText(document.getElementById('quiz-input').value.trim()) }; if (!testData.title || !testData.timeLimit || testData.questions.length === 0) { alert("Vui lòng điền đủ các trường bắt buộc!"); return; } try { await db.ref('tests/' + testId).set(testData); alert(`Đã lưu thành công!`); this.renderView('adminManage', { forceReload: true, icon: 'list' }); } catch (error) { console.error("Lỗi khi lưu đề thi:", error); alert("Đã xảy ra lỗi khi lưu đề thi."); } },
            editTest(testId) { this.renderView('adminCreateTest'); setTimeout(() => { const test = this.tests.find(t => t.id === testId); if (!test) return; document.getElementById('create-edit-title').innerText = "Chỉnh Sửa Đề Thi"; document.getElementById('test-id-edit').value = test.id; document.getElementById('test-title').value = test.title; document.getElementById('test-time').value = test.timeLimit; document.getElementById('test-attempts').value = test.maxAttempts === Infinity ? '' : test.maxAttempts; document.getElementById('test-category').value = test.category; document.getElementById('allow-view-answer').checked = test.showAnswers !== false; document.getElementById('test-audio-url').value = test.audioUrl; document.getElementById('save-test-btn').innerText = "CẬP NHẬT"; const rawText = test.questions.map(q => { let str = ''; if (q.type === 'passage_question') { str += `[PASSAGE] ${q.passage}\n`; } str += q.prompt + '\n'; for (const key in q.options) { str += `${key}${q.answer === key ? '*' : ''}) ${q.options[key]}\n`; } if (q.explanation) str += `[GTHICH] ${q.explanation}`; return str; }).join('\n---\n'); document.getElementById('quiz-input').value = rawText; }, 0); },
            async deleteTest(testId) { const testToDelete = this.tests.find(t => t.id === testId); if (!testToDelete) return; if (confirm(`Bạn có chắc chắn muốn xóa đề thi "${testToDelete.title}"? Tất cả kết quả liên quan cũng sẽ bị xóa vĩnh viễn!`)) { try { await db.ref('tests/' + testId).remove(); const scoresSnapshot = await db.ref('scores').orderByChild('testId').equalTo(testId).once('value'); const scoresToDelete = scoresSnapshot.val(); if (scoresToDelete) { const updates = {}; Object.keys(scoresToDelete).forEach(key => { updates[key] = null; }); await db.ref('scores').update(updates); } alert("Đã xóa đề thi thành công."); this.renderView('adminManage', { forceReload: true, icon: 'list' }); } catch (error) { console.error("Lỗi khi xóa đề thi:", error); alert("Đã xảy ra lỗi."); } } },
            renderAdminTestList() { const list = document.getElementById('admin-test-list'); if (!list) return; list.style.display = 'grid'; list.style.gridTemplateColumns = 'repeat(auto-fill, minmax(280px, 1fr))'; list.style.gap = '20px'; if (this.tests.length === 0) { list.innerHTML = `<p>Chưa có đề thi nào.</p>`; return; } list.innerHTML = ''; this.tests.forEach(test => { const card = document.createElement('div'); card.className = 'test-card'; card.innerHTML = `<h3>${test.title} ${test.audioUrl ? '🎧' : ''}</h3><p>${test.questions.length} câu - ${test.timeLimit} phút</p><div class="test-card-footer"> <button class="action-button action-btn-small" onclick="app.editTest(${test.id})">Sửa</button> <button class="action-button action-btn-small" style="background-color: #9b59b6;" onclick="app.renderView('adminManageUsers')">Người dùng</button> <button class="action-button action-btn-small" style="background-color: var(--info-color);" onclick="app.resetUserAttempts(${test.id}, '${test.title.replace(/'/g, "\\'")}')">Reset Lượt</button> <button class="action-button btn-delete action-btn-small" onclick="app.deleteTest(${test.id})">Xóa</button> </div>`; list.appendChild(card); }); },
            renderManageUsers() { const container = document.getElementById('user-management-table'); if (!container) return; let tableContent = ''; if (this.users.length > 0) { tableContent += `<table class="admin-table"><thead><tr><th>Tên tài khoản</th><th>Số bài đã thi</th><th>Trạng thái</th><th>Hành động</th></tr></thead><tbody>`; this.users.forEach(user => { const isCurrentUserAdmin = user.username === 'admin'; const testsTaken = this.scores.filter(s => s.username === user.username).length; const status = user.isBanned ? '<span style="color:var(--danger-color); font-weight:bold;">Bị cấm</span>' : '<span style="color:var(--success-color);">Hoạt động</span>'; const banButton = user.isBanned ? `<button class="admin-action-btn btn-unban" onclick="app.toggleBanUser('${user.username}')" ${isCurrentUserAdmin ? 'disabled' : ''}>Mở khóa</button>` : `<button class="admin-action-btn btn-ban" onclick="app.toggleBanUser('${user.username}')" ${isCurrentUserAdmin ? 'disabled' : ''}>Cấm</button>`; tableContent += `<tr><td>${user.username} ${user.isAdmin ? '👑' : ''}</td><td>${testsTaken}</td><td>${status}</td><td> <button class="admin-action-btn btn-edit-user" onclick="app.promptEditPassword('${user.username}')">Đổi MK</button> ${banButton} <button class="admin-action-btn btn-clear-scores" onclick="app.clearUserScores('${user.username}')" ${isCurrentUserAdmin ? 'disabled' : ''}>Xóa Toàn Bộ Điểm</button> </td></tr>`; }); tableContent += `</tbody></table>`; } else { tableContent = '<p>Không có tài khoản người dùng nào.</p>'; } container.innerHTML = tableContent; },
            renderUserHistory() { const div = document.getElementById('user-history'); if(!div) return; const userScores = this.scores.filter(s => s.username === this.currentUser.username).sort((a,b) => b.date - a.date); if(userScores.length === 0) { div.innerHTML = `<p>Bạn chưa làm bài thi nào.</p>`; return; } div.innerHTML = ''; userScores.forEach(scoreRecord => { const test = this.tests.find(ts => ts.id === scoreRecord.testId); const item = document.createElement('div'); item.className = 'history-item'; let reviewButton = `<button class="btn-review" onclick="app.renderView('resultsView', { scoreRecordKey: '${scoreRecord.key}' })">Xem lại</button>`; if (!test) { reviewButton = `<button class="btn-review" disabled>Đã xóa</button>`; } item.innerHTML = `<div><strong>${test ? test.title : '(Đề đã xóa)'}</strong><br><small style="color:#888">${new Date(scoreRecord.date).toLocaleString()}</small></div><div style="display:flex; align-items:center;"><strong style="font-weight:700;">${scoreRecord.score * 10}/${scoreRecord.total * 10}</strong>${reviewButton}</div>`; div.appendChild(item); }); },
            renderResults(scoreRecordKey) { const scoreRecord = this.scores.find(s => s.key === scoreRecordKey); if (!scoreRecord) { alert("Lỗi: Không tìm thấy kết quả bài làm."); this.renderView('userDashboard', {forceReload: true}); return;} const test = this.tests.find(t => t.id === scoreRecord.testId); if (!test) { alert("Lỗi: Không tìm thấy dữ liệu đề thi này. Có thể nó đã bị xóa."); this.renderView('userDashboard', {forceReload: true}); return; } this.renderContent('resultsView'); setTimeout(() => { document.getElementById('score-summary').textContent = `Điểm số: ${scoreRecord.score * 10} / ${scoreRecord.total * 10}`; const breakdownContainer = document.getElementById('results-breakdown'); let resultsHtml = ''; let questionCounter = 0; test.questions.forEach((q, i) => { questionCounter++; const userAnswer = scoreRecord.userAnswers ? scoreRecord.userAnswers[i] : null; const isCorrect = userAnswer === q.answer; if (q.type === 'passage_question') { resultsHtml += `<div class="passage-block">${q.passage}</div>`; } resultsHtml += `<div class="result-item" style="border: 1px solid ${isCorrect ? 'var(--success-color)' : 'var(--danger-color)'}; padding: 15px; border-radius: 8px; margin-bottom: 15px;"><h4>Câu ${questionCounter}: ${q.prompt}</h4><p><strong>Bạn chọn:</strong> ${userAnswer && q.options[userAnswer] ? `(${userAnswer}) ${q.options[userAnswer]}` : '<span style="color:red">Chưa trả lời</span>'}</p>`; if (test.showAnswers !== false) { if (!isCorrect) { resultsHtml += `<p style="color:green;"><strong>Đáp án đúng:</strong> (${q.answer}) ${q.options[q.answer]}</p>`; } if (q.explanation) { resultsHtml += `<div class="explanation" style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin-top: 10px;"><strong>Giải thích:</strong> ${q.explanation}</div>`; } } resultsHtml += `</div>`; }); breakdownContainer.innerHTML = resultsHtml; document.getElementById('back-btn').addEventListener('click', () => this.renderView('userDashboard')); }, 0); },
            async checkAnswers() { if(!this.currentQuiz) return; clearInterval(this.timerInterval); let score = 0; const userAnswers = {}; const quizData = this.currentQuiz; quizData.questions.forEach((q, i) => { const selected = document.querySelector(`input[name="q${i}"]:checked`); userAnswers[i] = selected ? selected.value : null; if (selected && selected.value === q.answer) score++; }); const total = quizData.questions.length; const scoreRecord = { key: db.ref().child('scores').push().key, username: this.currentUser.username, testId: quizData.id, score, total, date: Date.now(), userAnswers }; try { await db.ref('scores/' + scoreRecord.key).set(scoreRecord); this.scores.push(scoreRecord); this.renderResults(scoreRecord.key); } catch (error) { console.error("Lỗi khi nộp bài:", error); alert("Không thể lưu kết quả. Vui lòng kiểm tra kết nối mạng."); } },
            startQuiz(testId) { const test = this.tests.find(t => t.id === testId); if (!test) return; this.currentQuiz = test; const mainContent = document.getElementById('main-content-area'); let questionsHtml = ''; let questionCounter = 0; test.questions.forEach((q, i) => { let optionsHtml = ''; questionCounter++; for (const key in q.options) { optionsHtml += `<label style="display: block; margin-bottom: 10px; background: #f9f9f9; padding: 10px; border-radius: 8px;"><input type="radio" name="q${i}" value="${key}"> <strong>${key}.</strong> ${q.options[key]}</label>`; } if (q.type === 'passage_question') { questionsHtml += `<div class="passage-block" style="white-space: pre-wrap;">${q.passage}</div>`; } questionsHtml += `<div class="card" style="margin-bottom: 20px;"><p><strong>Câu ${questionCounter}:</strong> ${q.prompt}</p><div class="options">${optionsHtml}</div></div>`; }); mainContent.innerHTML = `<div class="card"><div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;"><h2>${test.title}</h2><div id="timer" style="font-size: 1.5em; font-weight: 700; color: var(--primary-color);"></div></div>${test.audioUrl ? `<audio controls src="${test.audioUrl}" style="width:100%; margin-bottom:20px;"></audio>` : ''}<form id="quiz-form">${questionsHtml}</form><button id="submit-btn" class="action-button">NỘP BÀI</button></div>`; document.getElementById('submit-btn').addEventListener('click', () => this.checkAnswers()); this.startTimer(test.timeLimit * 60); },
            parseQuizText(text) { return text.trim().split('---').map(block => { if (!block.trim()) return null; const lines = block.trim().split('\n'); if (lines[0].trim().startsWith('[PASSAGE]')) { const passageText = lines.shift().trim().replace('[PASSAGE]', '').trim(); const prompt = lines.shift()?.trim() || ''; const options = {}; let answer = null; let explanation = ""; lines.forEach(line => { const optMatch = line.trim().match(/^([A-D])(\*?)\)\s*(.*)/); if (optMatch) { const [, key, isCorrect, value] = optMatch; options[key] = value.trim(); if (isCorrect) answer = key; } else if (line.trim().startsWith('[GTHICH]')) { explanation = line.trim().replace('[GTHICH]', '').trim(); } }); return { type: 'passage_question', passage: passageText, prompt, options, answer, explanation }; } else { const prompt = lines.shift()?.trim() || ''; const options = {}; let answer = null; let explanation = ""; lines.forEach(line => { const optMatch = line.trim().match(/^([A-D])(\*?)\s*(.*)/); if (optMatch) { const [, key, isCorrect, value] = optMatch; options[key] = value.trim(); if (isCorrect) answer = key; } else if (line.trim().startsWith('[GTHICH]')) { explanation = line.trim().replace('[GTHICH]', '').trim(); } }); return { type: 'question', prompt, options, answer, explanation }; } }).filter(q => q.prompt); },
            renderUserStats: function() { const container = document.getElementById('user-stats-card-container'); if (!container) return; const userScores = this.scores.filter(s => s.username === this.currentUser.username); const uniqueTestsTaken = new Set(userScores.map(s => s.testId)).size; const bestScoresMap = new Map(); userScores.forEach(score => { if (!bestScoresMap.has(score.testId) || score.score > bestScoresMap.get(score.testId).score) { bestScoresMap.set(score.testId, score); } }); const totalPoints = Array.from(bestScoresMap.values()).reduce((sum, score) => sum + (score.score * 10), 0); container.innerHTML = `<div class="card user-stats-card"><h3>Chào, ${this.currentUser.username}!</h3><div class="user-stats-grid"><div class="stat-item"><div class="value">${uniqueTestsTaken}</div><div class="label">Đề đã luyện</div></div><div class="stat-item"><div class="value">${totalPoints.toLocaleString('vi-VN')}</div><div class="label">Tổng điểm</div></div></div></div>`; },
            renderCategoryShowcase: function() { const container = document.getElementById('category-showcase-grid'); if (!container) return; container.innerHTML = ''; CATEGORIES.forEach(cat => { const card = document.createElement('div'); card.className = 'category-showcase-card'; card.onclick = () => this.renderView('categoryView', { categoryName: cat.name }); card.innerHTML = `<div class="icon"><svg style="width:1em; height:1em;"><use href="#icon-${cat.icon}"></use></svg></div><h3>${cat.name}</h3>`; container.appendChild(card); }); },
            renderTestGridForCategory: function(categoryName) { const container = document.getElementById('test-grid'); const title = document.getElementById('category-view-title'); if (!container || !title) return; title.innerHTML = `<svg class="icon"><use href="#icon-${CATEGORIES.find(c => c.name === categoryName).icon}"></use></svg> ${categoryName}`; const filteredTests = this.tests.filter(test => test.category === categoryName); if (filteredTests.length === 0) { container.innerHTML = `<p style="text-align:center; padding: 20px;">Chưa có đề thi nào trong mục này. Quay lại sau nhé!</p>`; return; } container.innerHTML = ''; filteredTests.forEach(test => { const attempts = this.scores.filter(s => s.username === this.currentUser.username && s.testId === test.id).length; const canTake = test.maxAttempts === Infinity || attempts < test.maxAttempts; const card = document.createElement('div'); card.className = 'test-card'; let footerHtml = canTake ? `<button class="btn-start" onclick="app.startQuiz(${test.id})">Làm bài</button>` : `<div class="status-locked">Đã hết lượt</div>`; const attemptsText = test.maxAttempts !== Infinity ? `<div style="font-size:0.8em;text-align:center;margin-bottom:8px;">Đã làm: ${attempts}/${test.maxAttempts}</div>` : ''; card.innerHTML = `<div><h3>${test.title} ${test.audioUrl ? '🎧' : ''}</h3><p>${test.questions.length} câu - ${test.timeLimit} phút</p></div><div class="test-card-footer">${attemptsText}${footerHtml}</div>`; container.appendChild(card); }); },
            renderLeaderboards: function() { clearInterval(this.leaderboardTimerInterval); const container = document.getElementById('leaderboard-container'); if (!container) return; container.innerHTML = `<div class="leaderboard-tabs"><button id="tab-global" class="active">Chung</button><button id="tab-per-test">Theo Đề</button></div><div id="leaderboard-content-container"></div>`; const tabGlobal = document.getElementById('tab-global'); const tabPerTest = document.getElementById('tab-per-test'); const setActiveTab = (activeTab) => { tabGlobal.classList.remove('active'); tabPerTest.classList.remove('active'); activeTab.classList.add('active'); }; tabGlobal.onclick = () => { setActiveTab(tabGlobal); this.renderGlobalLeaderboardContent(); }; tabPerTest.onclick = () => { setActiveTab(tabPerTest); this.renderPerTestLeaderboardSelector(); }; this.renderGlobalLeaderboardContent(); const timerEl = document.getElementById('leaderboard-timer'); let nextUpdate = localStorage.getItem('quiz_next_update_v4'); if (!nextUpdate || Date.now() > parseInt(nextUpdate)) { nextUpdate = Date.now() + 24 * 60 * 60 * 1000; localStorage.setItem('quiz_next_update_v4', nextUpdate); } this.leaderboardTimerInterval = setInterval(() => { const remaining = parseInt(nextUpdate) - Date.now(); if (remaining <= 0) { timerEl.textContent = 'Đang cập nhật...'; localStorage.removeItem('quiz_next_update_v4'); location.reload(); } else { const hours = Math.floor(remaining / 36e5), minutes = Math.floor((remaining / 6e4) % 60), seconds = Math.floor((remaining / 1e3) % 60); timerEl.textContent = `BXH Chung làm mới sau: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`; } }, 1000); },
            renderGlobalLeaderboardContent: function() { const container = document.getElementById('leaderboard-content-container'); if (!container) return; const userPoints = new Map(); this.users.forEach(user => { const userScores = this.scores.filter(s => s.username === user.username); const bestScoresMap = new Map(); userScores.forEach(score => { if (!bestScoresMap.has(score.testId) || score.score > bestScoresMap.get(score.testId).score) { bestScoresMap.set(score.testId, score); } }); const totalPoints = Array.from(bestScoresMap.values()).reduce((sum, score) => sum + (score.score * 10), 0); userPoints.set(user.username, totalPoints); }); const sortedUsers = Array.from(userPoints.entries()).sort(([, pointsA], [, pointsB]) => pointsB - pointsA); if (sortedUsers.length === 0) { container.innerHTML = `<p>Chưa có dữ liệu xếp hạng.</p>`; return; } let html = ''; sortedUsers.forEach(([username, points], i) => { html += `<div style="display:flex; align-items:center; margin-bottom:10px;"><div style="font-weight:700; margin-right:15px; width:20px;">${i + 1}.</div><div><strong>${username} ${this.users.find(u=>u.username===username)?.isAdmin ? '👑' : ''}</strong></div><div style="margin-left:auto; color:var(--primary-color); font-weight:700; display:flex; align-items:center;">${points.toLocaleString('vi-VN')}<svg class="icon icon-fire"><use href="#icon-fire"></use></svg></div></div>`; }); container.innerHTML = html; },
            renderPerTestLeaderboardSelector: function() { const container = document.getElementById('leaderboard-content-container'); if (!container) return; if (this.tests.length === 0) { container.innerHTML = '<p>Chưa có bài thi nào để xếp hạng.</p>'; return; } let options = this.tests.map(test => `<option value="${test.id}">${test.title}</option>`).join(''); container.innerHTML = `<div id="per-test-leaderboard-selector" class="input-group"><select onchange="app.renderPerTestLeaderboardContent(this.value)">${options}</select></div><div id="per-test-leaderboard-content"></div>`; if (this.tests.length > 0) {this.renderPerTestLeaderboardContent(this.tests[0].id);} },
            renderPerTestLeaderboardContent: function(testId) { const contentDiv = document.getElementById('per-test-leaderboard-content') || document.getElementById('leaderboard-content-container'); if (!contentDiv || !testId) return; const testScores = this.scores.filter(s => s.testId == testId); const bestScores = new Map(); testScores.forEach(score => { if (!bestScores.has(score.username) || score.score > bestScores.get(score.username).score) { bestScores.set(score.username, score); } }); const sortedUsers = Array.from(bestScores.values()).sort((a, b) => b.score - a.score); if (sortedUsers.length === 0) { contentDiv.innerHTML = `<p style="text-align:center; color:#888;">Chưa có dữ liệu cho bài thi này.</p>`; return; } let html = ''; sortedUsers.forEach((u, i) => { html += `<div style="display:flex; align-items:center; margin-bottom:10px;"><div style="font-weight:700; margin-right:15px; width:20px;">${i+1}.</div><div><strong>${u.username} ${this.users.find(user=>user.username===u.username)?.isAdmin ? '👑' : ''}</strong></div><div style="margin-left:auto; color:var(--primary-color); font-weight:700;">${u.score * 10} / ${u.total * 10}</div></div>`; }); contentDiv.innerHTML = html; },
            renderProgressChart: function() { const ctx = document.getElementById('progress-chart'); if (!ctx) return; const userScores = this.scores.filter(s => s.username === this.currentUser.username).sort((a,b) => a.date - b.date); if (this.progressChart) { this.progressChart.destroy(); } if (userScores.length < 2) { ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height); ctx.outerHTML = '<canvas id="progress-chart"></canvas><p style="text-align:center; color:#888;">Cần ít nhất 2 lần làm bài để vẽ biểu đồ.</p>'; return; } const labels = []; const dataPoints = []; let cumulativeScore = 0; const bestScoresMap = new Map(); userScores.forEach(score => { bestScoresMap.set(score.testId, Math.max(bestScoresMap.get(score.testId) || 0, score.score)); cumulativeScore = Array.from(bestScoresMap.values()).reduce((sum, s) => sum + (s * 10), 0); labels.push(new Date(score.date).toLocaleDateString('vi-VN')); dataPoints.push(cumulativeScore); }); this.progressChart = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Tổng điểm tích lũy', data: dataPoints, fill: true, backgroundColor: 'rgba(255, 126, 154, 0.2)', borderColor: 'rgba(255, 126, 154, 1)', tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: true } }); },
            renderTipOfTheDay: function() { const container = document.getElementById('tip-of-the-day-card'); if (!container) return; const tip = this.studyTips[Math.floor(Math.random() * this.studyTips.length)]; container.innerHTML = `<h3><svg class="icon" style="width:1.2em; height:1.2em; margin-right: 8px;"><use href="#icon-lightbulb"></use></svg>Góc học tập</h3><p>"${tip}"</p>`; },
            startTimer: function(duration) { let t = duration; const el = document.getElementById('timer'); clearInterval(this.timerInterval); this.timerInterval = setInterval(() => { let m = Math.floor(t / 60), s = t % 60; if(el) el.innerHTML = `<svg class="icon" style="width:1em; height:1em; vertical-align: -0.1em; margin-right: 5px;"><use href="#icon-clock"></use></svg>${m<10?'0':''}${m}:${s<10?'0':''}${s}`; if(--t < 0){ clearInterval(this.timerInterval); alert("Hết giờ làm bài!"); this.checkAnswers(); } }, 1000); },
        };
    
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
